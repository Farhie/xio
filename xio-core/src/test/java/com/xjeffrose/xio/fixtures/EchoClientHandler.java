package com.xjeffrose.xio;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandler.Sharable;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.util.CharsetUtil;

/**
 * Listing 2.3 of <i>Netty in Action</i>
 *
 * @author <a href="mailto:norman.maurer@googlemail.com">Norman Maurer</a>
 */
@Sharable
public class EchoClientHandler extends SimpleChannelInboundHandler<ByteBuf> {

  private int outMsgLength;
  private int inMsgLength = 0;

  @Override
  public void channelActive(ChannelHandlerContext ctx) {
    String msg =
        "Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!Netty rocks!";
    outMsgLength = msg.length();
    System.out.println("Out size: " + msg.length());
    ctx.writeAndFlush(Unpooled.copiedBuffer(msg, CharsetUtil.UTF_8));
  }

  @Override
  public void channelRead0(ChannelHandlerContext ctx, ByteBuf in) {
    String inMsg = in.toString(CharsetUtil.UTF_8);
    inMsgLength += inMsg.length();
    System.out.println("Client received: " + inMsg.length());
    if (inMsgLength == outMsgLength) {
      ctx.close();
    }
  }

  @Override
  public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
    cause.printStackTrace();
    ctx.close();
  }
}
